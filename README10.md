# CHAPTER10 エラーハンドリングとログの活用
10-1 エラーハンドリング  
10-2 ログ活用パターン

# 10-1 エラーハンドリング
エラー表示  
　.envファイルに記述されているAPP_DEBUGをtrueにするとエラー内容がブラウザなどの表示画面に出力される。  
プロダクション環境でのエラー表示は脆弱性につながるため、APP_DEBUGはfalseにする。  
開発環境ではtrueで良い。

エラーの種別  
　Laravelには補足しきれなかった例外を処理するためにApp\Exceptions\Handlerクラスがあ用意されている。  
アプリケーションで発生する例外は大別すると以下の通り。  
・システム例外  
　処理を実行できない例外。アプリケーションそのものに由来するバグ、依存ライブラリのバグ、データベースやキャッシュサーバーなどのハードウェア・ミドルウェアのよる障害、ネットワーク障害など。

・不正リクエスト例外  
　アプリケーションへの不正なリクエストで発生する例外を指す。存在しないURIへのリクエストやバリデーションエラーなどが該当する。  
ミドルウェア、フォームリクエスト、バリデーションなどの機能を利用してエラーハンドリングを行う。

・アプリケーション例外  
　アプリケーションで定義される、ビジネスロジックに関連するエラーが該当する。  
ユーザー登録処理で重複のエラーや在庫不足など、アプリケーションが定めている正常な処理を続行できない例外は、要件に合わせて的確に処理をする必要がある。

エラーハンドリングの基本  
　アプリケーション内でエラーがハンドリングされなかった場合、Laravel標準のApp\Exception\Handlerクラスがエラーハンドリングを担う。  
このクラスには発生した例外を記録としてログに書き込むreportメソッドと、エラー発生時にレスポンスを作成するrenderメソッドがある。  
様々な要因で例外が発生するため、エラー原因をログに残すことは重要。  
　reportメソッドで処理されない例外もいくつかあるので注意が必要。
AuthenticationException、AuthorizationException、HttpException、ModelNotFoundException、MultipleNotFoundException、RecordNotFoundException、SuspiciousOperationException、TokenMismatchException、ValidationExceptionが該当する。

Fluentdの活用  
　特定の例外だけ記録処理を変更する場合は、任意の処理を追記できる。  
Fluentdを使って複数のアプリケーションエラーを収集するケースなどでは、reportメソッドからFluentdサーバに送信することが想定できる。

例外の描画テンプレート変更  
　Laravelではフレームワークで用意されている例外に対応する描画テンプレートが用意されている。  
テンプレートはHTTPステータスコードの対応しているため、アプリケーションに合わせてエラー発生時に描画されるテンプレートを変更する場合は、resources/views/errors配下にテンプレートファイルを設置する。  
例）resources/views/errors/404.blade.php

　Acceptヘッダのメディアタイプにtext/jsonかapplication/json、application/hal+jsonと+json指定がある場合はbaldeテンプレートではなくJSONレスポンスで返却される。

　特定の例外で任意のレスポンスを返却する場合は、renderメソッド内に実装することで対応できる。

エラーハンドリングパターン  
　フレームワークで用意されている例外クラスではなく、アプリケーション固有の例外クラスが多くなると、App\Exceptions\Handlerクラスのrenderメソッド内でエラーの分岐処理が多くなり、レスポンスの処理が複雑になりがちである。  
複雑化を防ぐため、Illuminate\Contracts\Support\Responsableインターフェースを実装した、例外クラスとレスポンスを関連づける方法が用意されている。




# 10-2 ログ活用パターン

# 不明点
- [ ] 

# 調べたこと
